# 构建基于TCP传输服务的多客户端交流平台项目

## 需求分析

1.  注册用户才能进入聊天室，要求用户名不能重复，注册用户进入时需身份验证；
2.  有人进入聊天室时，其他人会收到通知：[用户名] 进入了聊天室；
3.  一个人发消息，其他人会收到：[用户名]： [信息内容]
4.  有人在群里发送文件后，其他人可以选择进行下载
5.  发起双人游戏邀请，其他人可选择加入，有一个加入后，其他人不得再加入
6.  有人退出聊天室，则其他人也会收到通知：[用户名]退出了聊天室
7.  服务器可以向所有用户发送公告:：管理员消息： [信息内容]

## 技术点分析

* 使用网络：流式套接字
* 请求和响应模型：客户端-->服务端-->数据处理
* 长期保存的信息：构建队列数据结构，信息先临时存至队列，再由队列存至数据库
*  如何记录用户信息：    
  - 字典：临时存储用户名称和地址(需要频繁调用)：`{name1：address1,name2:address2,...}`   
  -  数据库的使用：       
    - 基本信息表：主表，包括用户名，密码，地址
    - 聊天信息记录表
    - 文件发送信息记录表
    - 游戏信息记录表
*  服务端：  
  - IO多路复用，实现信息转发
  - 接收文件时，单独创建线程下载文件，不影响各客户端交流
*  客户端：    
  - 多进程：一个进程控制发送，一个进程控制接收           
  - 发文件或游戏邀请时，单独创建线程，各功能互不影响

## 结构的设计和协议的设计

* 构建数据库
* 网络通信搭建
* 进入聊天室
* 普通聊天
* 发送文件
* 发送游戏邀请
* 退出聊天室
* 管理员消息



封装方法：全部采用类封装，包括启动程序，除导入模块，不允许有在类外部的语句



- 协议设计：   
  - 进入聊天：       
    - 用户名：“U ” + name      
    - 密码:  “P " + name + password  
  - 反馈： 服务端发送 "OK"  其他的为失败   
  - 聊天：     “C ” + name + content    
  - 发文件： “F ” + name + file_path    
  - 下文件： “L ” + name + file_name    
  - 游戏邀请：  “G " + name    
  - 接受邀请：  ”D " + name + 发起者name    
  - 退出：     “E ” + name

## 逐个功能分析，列出逻辑流程

### 构建队列类

- 作为数据库存放前的缓存区
- 分别构建“基本信息队列”、“聊天记录队列”、“文件传输队列”、“対弈记录队列” 这4个队列实例对象各项数据先存放到对应队列实例中，再由队列存放至数据库中

### 构建数据库

- 库名：chat_room
- 主表：    
  - 表名：  base_info    
  - 字段名：id   name   password    address    register_time(default now())
- 聊天记录表：    
  - 表名：  chat_history    
  - 字段名：id   comment     send_time(default now())    level    uid(foreign key)
- 文件传输记录表：    
  - 表名：  file_put_record    
  - 字段名：id   file_name   send_time(default now())    level    uid(foreign key)    file_comment
- 游戏対弈记录表：    
  - 表名：  game_record    
  - 字段名：id   result      start_time(default now())   level    uid(foreign key)

### 网络通信搭建

- 服务端：   

  -  IO多路复用，实现信息转发
  - 接收文件时，单独创建线程下载文件，不影响各客户端交流

- 客户端：    

  - 多进程：一个进程控制发送，一个进程控制接收           

  - 发文件或游戏邀请时，单独创建线程，各功能互不影响

### 进入聊天室    

- 客户端：        
  - 首次进入：            
    1. 注册            
    2. 注册成功后登录            
    3. 接收登录请求结果(成功，失败)        
  - 非首次进入：            
    1. 登录            
    2. 接收登录请求结果(成功，失败)
- 服务端：    
  1. 接收用户名和密码    
  2. 判断用户名是否存在        
     - 不存在反馈 “用户名不存在，是否要注册”        
     - 存在则判断密码是否正确，正确允许进入（监控和其对应的套接字），不正确则反馈重新输入，3次机会，用尽则关闭和其对应的套接字    
  3. 如果允许进入，告知其他客户端

### 普通聊天    

- 客户端：
  - 创建新的线程           
  - 一个线程收消息           
  - 一个线程发消息    
- 服务端：
  - 接受请求(请求类型区分)           
  - 发送给其他人

### 发送文件

- 客户端：        
  1. 发送请求        
  2. 接收反馈        
  3. 创建线程，开始发送文件内容    
- 服务端：        
  1. 接收请求        
  2. 判断请求，文件名已存在则拒绝，不存在则反馈“OK”，        
  3. 允许上传，创建线程接收文件，存储到数据库，存储完成后转发其他人文件名

### 下载其他人上传的文件

- 客户端：        
  1. 发送请求        
  2. 接收反馈        
  3. 允许下载则输入存储目录        
  4. 创建线程，开始接收并下载    

- 服务端：        
  1. 接收请求        
  2. 判断请求，文件存在则反馈"OK"，创建线程获取文件内容并发送

### 发送游戏邀请

- 客户端：        
  1. 发送请求        
  2. 创建线程，开启游戏        
  3. 等待对手进入    
- 服务端：        
  1. 接收请求        
  2. 判断请求        
  3. 将游戏邀请信息转发其他人

### 接收游戏邀请

- 客户端：        
  1. 发送请求(应邀谁发起的游戏)        
  2. 接收反馈        
  3. 若发起者处于等待状态，创建线程，则进入对局    
- 服务端：        
  1. 接收请求        
  2. 判断请求(若发起者等待状态，反馈“OK”，否则反馈拒绝)

### 退出聊天室

- 客户端：
  1. 输入退出标志           
  2. 发送请求           
  3. 进程结束    
- 服务端：
  1. 接受请求（请求类型区分）           
  2. 告知其他人           
  3. 将用户从user中移除

### 管理员消息